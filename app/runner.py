import concurrent.futures
import time
from src import utility
from src import main_operations


def main():
    utility.Utility.log_stdout("Custom Image Vulnerabilities Report")
    main_operations_obj = main_operations.MainOperations()

    """
    # Reading and Initializing Configuration Parameters of Custom Image Vulnerabilities Report.
    """
    halo_api_caller_obj, json_to_csv_obj, output_directory, config = main_operations_obj.initilize_parameters()

    """
    # Checking/validating provided configuration parameters
    """
    main_operations_obj.check_configs(config, halo_api_caller_obj)

    """
    # Prepare Thread Statistics based on Number of Container Images
    """
    total_no_of_pages, pages_per_thread = main_operations_obj.prepare_thread_statistics(
        halo_api_caller_obj)

    """
    # Prepare CSV file for Writing
    """
    absolute_path, file_name, current_time = main_operations_obj.preparing_report_output_files(
        json_to_csv_obj, output_directory)

    """
    # Reading Image Vulnerabilities Data from the API host
    """
    pages_lst = list(range(1, total_no_of_pages+1))
    chunk_size = pages_per_thread
    thread_id = 0
    total_threads_statistics = [0, 0, 0, 0, 0, 0, 0, 0, 0]

    threaded_start_time = time.time()
    with concurrent.futures.ThreadPoolExecutor() as executor:
        futures = []
        for i in range(0, len(pages_lst), chunk_size):
            thread_pages = pages_lst[i:i + chunk_size]
            thread_id += 1
            futures.append(executor.submit(main_operations_obj.get_detailed_list_of_images, config,
                           halo_api_caller_obj, json_to_csv_obj, absolute_path, thread_id, thread_pages, current_time))
        for future in concurrent.futures.as_completed(futures):
            statistics = future.result()
            total_threads_statistics[0] += statistics[0]
            total_threads_statistics[1] += statistics[1]
            total_threads_statistics[2] += statistics[2]
            total_threads_statistics[3] += statistics[3]
            total_threads_statistics[4] += statistics[4]
            total_threads_statistics[5] += statistics[5]
            total_threads_statistics[6] += statistics[6]
            total_threads_statistics[7] += statistics[7]
            total_threads_statistics[8] += statistics[8]
    threaded_end_time = time.time()
    consumed_time = threaded_end_time - threaded_start_time
    optimized_consumed_time = round(consumed_time, 3)
    utility.Utility.log_stdout(
        "Total Time Consumed = [%s] seconds" % (optimized_consumed_time))

    """
    # Creating Image Vulnerability Overall Statistics CSV file
    """
    main_operations_obj.write_overall_report_statistics(
        json_to_csv_obj, absolute_path, file_name, current_time, total_threads_statistics)

    """
    # Creating Image Vulnerability Graphs to Represent Overall Statistics
    """
    main_operations_obj.draw_graphs(
        output_directory, json_to_csv_obj, total_threads_statistics)


if __name__ == "__main__":
    main()
